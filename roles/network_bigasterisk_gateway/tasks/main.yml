---
- set_fact: ext="173.228.113.124" extMask="255.255.255.0" extNet="173.228.113.0" extBcast="173.228.113.255" extGateway="173.228.113.1" prime="162.243.138.136"

- template:
    dest=/etc/network/interfaces
    src=interfaces.j2
    owner=root
    group=root
    mode=0644
  notify: wifi net reset

- name: external address for nginx config
  copy:
    dest=/etc/nginx/external_address_mapping.conf
    content="# written by /my/proj/ansible/roles/network_bigasterisk_gateway/tasks/main.yml{{'\n'}}  {{ext}}/32 bang;{{'\n'}}"
    owner=root
    group=root
  notify: nginx update
  # this could perhaps go in /var/lib/nginx.d but watch out for a
  # cleaner removing all non-website files from there

- apt: pkg=iptables
  
- template:
    dest=/etc/network/firewall-setup
    src=firewall-setup.j2
    owner=root
    group=root
    mode=0755
  
- name: external address for firewall-setup
  copy:
    dest=/etc/network/firewall-setup.publicaddr
    content="# written by /my/proj/puppet/ansible/roles/network_bigasterisk_gateway/tasks/main.yml{{'\n'}}PUBLIC_ADDR={{ext}}{{'\n'}}"
    mode=644
    owner="root"
    group="root"
  notify: firewall setup

- name: write resolv.conf
  copy: dest=/etc/resolv.conf content="nameserver 10.2.0.1{{'\n'}}domain bigasterisk.com{{'\n'}}" force=yes
  tags: ['resolvconf']

# unused, with prime serving public dns?
#- include: dns.yml
  
# also when the IP changes:
#  /my/proj/netbars/netbars/traffic.py needs editing
#  install/restart netbars
#  change nameservers at namecheap, including ns20.quickwitretort.com which they don't normally show
#  change @ hover.com
#  change rdns at sonic   
  
- include: dhcp.yml
  tags: ['dhcp']

- include: house_dns.yml
  tags: ['house_dns']

- apt: pkg=openntpd
- apt: pkg=ntpdate

- copy: dest=/etc/timezone content="America/Los_Angeles"
- command: "dpkg-reconfigure --frontend noninteractive tzdata"

- apt: pkg=nfs-kernel-server
  tags: ['nfs']
- copy: dest=/etc/exports content="/var/cache/photo dash(sync,rw,no_subtree_check) 10.1.0.229(sync,rw,no_subtree_check) 10.1.0.21(sync,rw,no_subtree_check)\n"
  tags: ['nfs']
